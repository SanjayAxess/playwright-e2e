name: Automation Test Template

on:
  workflow_call:
    inputs:
      env_name:
        description: "Environment name (STAGING / PROD / QA / etc)"
        type: string
        required: true

      url:
        description: "Environment base URL"
        type: string
        required: true

      buyer_username:
        description: "Automation user for this environment"
        type: string
        required: true

      mongo_db:
        description: "Mongo DB name"
        type: string
        required: true

    secrets:
      buyer_password:
        required: true
      org_id:
        required: true
      mongo_uri:
        required: true
      teams_webhook_url:
        required: true
      nexus_npm_token:
        required: true

jobs:

  # ============================
  # START TIMER
  # ============================
  start-timer:
    name: Start Timer
    runs-on: [DevOpsLargeRunner]
    outputs:
      start_ts: ${{ steps.mark.outputs.start_ts }}

    steps:
      - name: Set start timestamp
        id: mark
        run: echo "start_ts=$(date +%s)" >> "$GITHUB_OUTPUT"


  # ============================
  # RUN TESTS WITH SHARDING
  # ============================
  run-tests:
    name: Run Playwright Tests
    needs: start-timer
    runs-on: [DevOpsLargeRunner]

    outputs:
      test_minsec: ${{ steps.duration.outputs.minsec }}

    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1,2,3,4,5,6,7,8,9,10]
        shardTotal: [10]

    env:
      HEADLESS: true
      ENV_NICKNAME: ${{ inputs.env_name }}
      URL: ${{ inputs.url }}
      BUYER_USERNAME: ${{ inputs.buyer_username }}
      BUYER_PASSWORD: ${{ secrets.BUYER_PASSWORD }}
      ORG_ID: ${{ secrets.org_id }}
      MONGO_URI: ${{ secrets.mongo_uri }}
      MONGO_DB: ${{ inputs.mongo_db }}
      TEAMS_WEBHOOK_URL: ${{ secrets.teams_webhook_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Write .npmrc for Nexus
        run: |
          echo "//nexus.integrate.ninja/repository/integrate-npm-group/:_authToken=${{ secrets.nexus_npm_token }}" > ~/.npmrc

      - name: Install Dependencies
        run: npm ci

      - name: Install Chromium
        run: npx playwright install chromium

      - name: Mark test start
        id: start
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Execute Tests
        run: |
          npx playwright test \
            --project=chromium \
            --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

      - name: Mark test end
        id: end
        if: always()
        run: echo "end=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Compute Duration
        id: duration
        shell: bash
        if: always()
        run: |
          start=${{ steps.start.outputs.start }}
          end=${{ steps.end.outputs.end }}
          dur=$((end - start))
          mins=$((dur/60))
          secs=$((dur%60))
          echo "minsec=${mins}m ${secs}s" >> $GITHUB_OUTPUT

      - name: Upload pie.json
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pie-${{ matrix.shardIndex }}
          path: blob-report/pie.json

      - name: Upload blob report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: blob-${{ matrix.shardIndex }}
          path: blob-report

  merge-reports:
    name: Merge Playwright Reports
    runs-on: [DevOpsLargeRunner]
    needs: [start-timer, run-tests]
    if: always()

    outputs:
      passed: ${{ steps.results.outputs.passed }}
      failed: ${{ steps.results.outputs.failed }}
      skipped: ${{ steps.results.outputs.skipped }}
      flaky: ${{ steps.results.outputs.flaky }}
      pieUrl: ${{ steps.results.outputs.pieUrl }}
      passPercentage: ${{ steps.results.outputs.passPercentage }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq + bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: merged-blobs
          pattern: blob-*
          merge-multiple: true

      - name: Merge HTML Report
        run: npx playwright merge-reports --reporter html merged-blobs

      - name: Download pie.json reports
        uses: actions/download-artifact@v4
        with:
          path: pie-reports
          pattern: pie-*
          merge-multiple: false

      - name: Merge pie.json
        run: node scripts/merge-pie-json.js pie-reports

      - name: Upload Final HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: playwright-report

      - name: Parse Results
        id: results
        run: |
          file="playwright-report/pie.json"
          if [ ! -f "$file" ]; then
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "flaky=0" >> $GITHUB_OUTPUT
            echo "pieUrl=" >> $GITHUB_OUTPUT
            echo "passPercentage=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          passed=$(jq -r '.passed' $file)
          failed=$(jq -r '.failed' $file)
          skipped=$(jq -r '.skipped' $file)
          flaky=$(jq -r '.flaky' $file)
          url=$(jq -r '.pieUrl' $file)
          total=$((passed+failed+skipped+flaky))
          [ "$total" -gt 0 ] && pct=$((passed*100/total)) || pct=0

          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "skipped=$skipped" >> $GITHUB_OUTPUT
          echo "flaky=$flaky" >> $GITHUB_OUTPUT
          echo "pieUrl=$url" >> $GITHUB_OUTPUT
          echo "passPercentage=$pct" >> $GITHUB_OUTPUT