name: Automation Test Template

on:
  workflow_call:
    inputs:
      env_name:
        description: "Environment name (STAGING / PROD / QA / etc)"
        type: string
        required: true

      url:
        description: "Environment base URL"
        type: string
        required: true

      buyer_username:
        description: "Automation user for this environment"
        type: string
        required: true

      mongo_db:
        description: "Mongo DB name"
        type: string
        required: true

    secrets:
      buyer_password:
        required: true
      org_id:
        required: true
      mongo_uri:
        required: true
      teams_webhook_url:
        required: true
      nexus_npm_token:
        required: true

jobs:

  # ============================
  # START TIMER
  # ============================
  start-timer:
    name: Start Timer
    runs-on: [DevOpsLargeRunner]
    outputs:
      start_ts: ${{ steps.mark.outputs.start_ts }}

    steps:
      - name: Set start timestamp
        id: mark
        run: echo "start_ts=$(date +%s)" >> "$GITHUB_OUTPUT"


  # ============================
  # RUN TESTS WITH SHARDING
  # ============================
  run-tests:
    name: Run Playwright Tests
    needs: start-timer
    runs-on: [DevOpsLargeRunner]

    outputs:
      test_minsec: ${{ steps.duration.outputs.minsec }}

    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1,2,3,4,5,6,7,8,9,10]
        shardTotal: [10]

    env:
      HEADLESS: true
      ENV_NICKNAME: ${{ inputs.env_name }}
      URL: ${{ inputs.url }}
      BUYER_USERNAME: ${{ inputs.buyer_username }}
      BUYER_PASSWORD: ${{ secrets.BUYER_PASSWORD }}
      ORG_ID: ${{ secrets.org_id }}
      MONGO_URI: ${{ secrets.mongo_uri }}
      MONGO_DB: ${{ inputs.mongo_db }}
      TEAMS_WEBHOOK_URL: ${{ secrets.teams_webhook_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Write .npmrc for Nexus
        run: |
          echo "//nexus.integrate.ninja/repository/integrate-npm-group/:_authToken=${{ secrets.nexus_npm_token }}" > ~/.npmrc

      - name: Install Dependencies
        run: npm ci

      - name: Install Chromium
        run: npx playwright install chromium

      - name: Mark test start
        id: start
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Execute Tests
        run: |
          npx playwright test \
            --project=chromium \
            --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

      - name: Mark test end
        id: end
        if: always()
        run: echo "end=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Compute Duration
        id: duration
        shell: bash
        if: always()
        run: |
          start=${{ steps.start.outputs.start }}
          end=${{ steps.end.outputs.end }}
          dur=$((end - start))
          mins=$((dur/60))
          secs=$((dur%60))
          echo "minsec=${mins}m ${secs}s" >> $GITHUB_OUTPUT

      - name: Upload pie.json
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pie-${{ matrix.shardIndex }}
          path: blob-report/pie.json

      - name: Upload blob report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: blob-${{ matrix.shardIndex }}
          path: blob-report

  merge-reports:
    name: Merge Playwright Reports
    runs-on: [DevOpsLargeRunner]
    needs: [start-timer, run-tests]
    if: always()

    outputs:
      passed: ${{ steps.results.outputs.passed }}
      failed: ${{ steps.results.outputs.failed }}
      skipped: ${{ steps.results.outputs.skipped }}
      flaky: ${{ steps.results.outputs.flaky }}
      pieUrl: ${{ steps.results.outputs.pieUrl }}
      passPercentage: ${{ steps.results.outputs.passPercentage }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq + bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: merged-blobs
          pattern: blob-*
          merge-multiple: true

      - name: Merge HTML Report
        run: npx playwright merge-reports --reporter html merged-blobs

      - name: Download pie.json reports
        uses: actions/download-artifact@v4
        with:
          path: pie-reports
          pattern: pie-*
          merge-multiple: false

      - name: Merge pie.json
        run: node scripts/merge-pie-json.js pie-reports

      - name: Upload Final HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: playwright-report

      - name: Parse Results
        id: results
        run: |
          file="playwright-report/pie.json"
          if [ ! -f "$file" ]; then
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "flaky=0" >> $GITHUB_OUTPUT
            echo "pieUrl=" >> $GITHUB_OUTPUT
            echo "passPercentage=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          passed=$(jq -r '.passed' $file)
          failed=$(jq -r '.failed' $file)
          skipped=$(jq -r '.skipped' $file)
          flaky=$(jq -r '.flaky' $file)
          url=$(jq -r '.pieUrl' $file)
          total=$((passed+failed+skipped+flaky))
          [ "$total" -gt 0 ] && pct=$((passed*100/total)) || pct=0

          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "skipped=$skipped" >> $GITHUB_OUTPUT
          echo "flaky=$flaky" >> $GITHUB_OUTPUT
          echo "pieUrl=$url" >> $GITHUB_OUTPUT
          echo "passPercentage=$pct" >> $GITHUB_OUTPUT

  deploy-report:
    name: Publish HTML Report and Notify Teams
    needs: [merge-reports, start-timer]
    if: ${{ always() && github.ref == 'refs/heads/main'}}
    runs-on: [DevOpsLargeRunner]
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq for JSON processing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download merged HTML report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ./playwright-report

      - name: Prepare gh-pages content with run-scoped folder
        run: |
          set -e
          RUN_ID="${{ github.run_id }}"
          REPORT_TMP="$RUNNER_TEMP/report"
          mkdir -p "$REPORT_TMP"
          cp -r ./playwright-report/* "$REPORT_TMP/" || true
          rm -rf site
          # Clone gh-pages if exists; otherwise initialize
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git clone --depth 1 --branch gh-pages "$REPO_URL" site || {
            mkdir -p site
            cd site
            git init
            git checkout -b gh-pages
            git remote add origin "$REPO_URL"
            echo "<html><body><h3>Reports</h3></body></html>" > index.html
            git add -A
            git commit -m "Initialize gh-pages branch" || true
            git push -u origin gh-pages
            cd ..
          }
          cd site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p "runs/$RUN_ID"
          rm -rf "runs/$RUN_ID"
          mkdir -p "runs/$RUN_ID"
          cp -r "$REPORT_TMP/"* "runs/$RUN_ID/" || true
          # Update latest pointer for convenience
          rm -rf latest
          mkdir -p latest
          cp -r "$REPORT_TMP/"* latest/ || true
          # Ensure index exists
          if [ ! -f index.html ]; then echo "<html><body><h3>Reports</h3></body></html>" > index.html; fi

      - name: Update history.json with current run
        continue-on-error: true
        working-directory: ./site
        run: |
          set -e

          # Only track history for main branch runs
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚è≠Ô∏è  Skipping history tracking - not on main branch (ref: ${{ github.ref }})"
            exit 0
          fi

          echo "‚úÖ Tracking history for main branch run"

          # Read existing history or create empty array
          if [ -f history.json ]; then
            echo "‚úÖ Found existing history.json"
            HISTORY=$(cat history.json)
          else
            echo "‚ö†Ô∏è No history.json found, creating new one"
            HISTORY="[]"
          fi

          # Get current date and timestamp in ISO format
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          CURRENT_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create new entry for this run
          NEW_ENTRY=$(cat <<EOF
          {
            "date": "$CURRENT_DATE",
            "timestamp": "$CURRENT_TIMESTAMP",
            "passed": ${{ needs.merge-reports.outputs.passed }},
            "failed": ${{ needs.merge-reports.outputs.failed }},
            "skipped": ${{ needs.merge-reports.outputs.skipped }},
            "flaky": ${{ needs.merge-reports.outputs.flaky }},
            "total": $((${{ needs.merge-reports.outputs.passed }} + ${{ needs.merge-reports.outputs.failed }} + ${{ needs.merge-reports.outputs.skipped }} + ${{ needs.merge-reports.outputs.flaky }})),
            "passPercentage": ${{ needs.merge-reports.outputs.passPercentage }},
            "runId": "${{ github.run_id }}"
          }
          EOF
          )

          # Append new entry to history
          UPDATED_HISTORY=$(echo "$HISTORY" | jq ". += [$NEW_ENTRY]")

          # Calculate date 30 days ago
          CUTOFF_DATE=$(date -u -d "30 days ago" +"%Y-%m-%d" 2>/dev/null || date -u -v-30d +"%Y-%m-%d")

          # Filter to keep only last 30 days
          FILTERED_HISTORY=$(echo "$UPDATED_HISTORY" | jq "[.[] | select(.date >= \"$CUTOFF_DATE\")]")

          # Write updated history
          echo "$FILTERED_HISTORY" > history.json

          # Log summary
          ENTRY_COUNT=$(echo "$FILTERED_HISTORY" | jq 'length')
          echo "‚úÖ Updated history.json with $ENTRY_COUNT entries (last 30 days)"
          echo "   Current run: Pass ${{ needs.merge-reports.outputs.passPercentage }}% (P:${{ needs.merge-reports.outputs.passed }} F:${{ needs.merge-reports.outputs.failed }} S:${{ needs.merge-reports.outputs.skipped }} FL:${{ needs.merge-reports.outputs.flaky }})"

      - name: Generate trends.html
        continue-on-error: true
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -e
          node scripts/generate-trends-html.js ./site/history.json ./site/trends.html

      - name: Commit and push to gh-pages
        working-directory: ./site
        run: |
          set -e
          git add -A
          git commit -m "Add report for run ${{ github.run_id }} with trends" || echo "No changes to commit"
          git push origin gh-pages

      - name: Wait for GitHub Pages to publish run URL
        if: always()
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          set -e
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          BASE_URL="https://$OWNER.github.io/$REPO"
          RUN_URL="$BASE_URL/runs/$RUN_ID/index.html"
          echo "Waiting for report to be live at: $RUN_URL"
          # Poll up to ~2 minutes for 200 OK (handle GH Pages propagation)
          for i in $(seq 1 24); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -H 'Cache-Control: no-cache' "$RUN_URL?ts=$(date +%s)")
            echo "Attempt $i -> HTTP $CODE"
            if [ "$CODE" = "200" ]; then
              echo "Report is live."
              break
            fi
            sleep 3
          done

      - name: Notify Teams with Workflow and HTML report links
        if: always()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          START_TS: ${{ needs.start-timer.outputs.start_ts }}
        run: |
          STATUS="${{ needs.merge-reports.result }}"
          COLOR="Good"; [ "$STATUS" != "success" ] && COLOR="Attention"
          CURRENT_TIME="$(TZ='America/Phoenix' date '+%Y-%m-%d %I:%M %p %Z')"
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO}"
          REPORT_URL="${BASE_URL%/}/runs/${{ github.run_id }}/index.html"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          NOW_TS="$(date +%s)"
          if [ -z "$START_TS" ]; then START_TS="$NOW_TS"; fi
          OVERALL_SEC="$((NOW_TS - START_TS))"
          if [ "$OVERALL_SEC" -lt 0 ]; then OVERALL_SEC=0; fi
          OVERALL_MIN="$((OVERALL_SEC/60))"
          OVERALL_REM_SEC="$((OVERALL_SEC%60))"
          OVERALL_MINSEC="${OVERALL_MIN}m ${OVERALL_REM_SEC}s"

          TRENDS_URL="${BASE_URL%/}/trends.html"

          cat > message.json <<EOF
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.4",
                  "body": [
                    { "type": "TextBlock", "size": "Large", "weight": "Bolder", "text": "üì¢ Playwright Tests completed: $STATUS", "color": "$COLOR" },
                    {
                      "type": "FactSet",
                      "facts": [
                        { "title": "‚úÖ Passed", "value": "${{ needs.merge-reports.outputs.passed }}" },
                        { "title": "‚ùå Failed", "value": "${{ needs.merge-reports.outputs.failed }}" },
                        { "title": "‚ö†Ô∏è Skipped", "value": "${{ needs.merge-reports.outputs.skipped }}" },
                        { "title": "‚ö° Flaky", "value": "${{ needs.merge-reports.outputs.flaky }}" },
                        { "title": "üìä Pass %", "value": "${{ needs.merge-reports.outputs.passPercentage }}%" },
                        { "title": "‚è± Total Run Time", "value": "$OVERALL_MINSEC" },
                        { "title": "üïí Completed At (AZ)", "value": "$CURRENT_TIME" }
                      ]
                    },
                    {
                      "type": "Image",
                      "url": "${{ needs.merge-reports.outputs.pieUrl }}",
                      "altText": "Test Results Pie Chart",
                      "size": "Stretch"
                    }
                  ],
                  "actions": [
                    { "type": "Action.OpenUrl", "title": "üîó View Workflow Run", "url": "$RUN_URL" },
                    { "type": "Action.OpenUrl", "title": "üìÑ Open HTML Report", "url": "$REPORT_URL" },
                    { "type": "Action.OpenUrl", "title": "üìà View Trends", "url": "$TRENDS_URL" }
                  ]
                }
              }
            ]
          }
          EOF
          curl -H "Content-Type: application/json" -d @message.json "$TEAMS_WEBHOOK_URL"